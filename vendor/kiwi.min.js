
/*-----------------------------------------------------------------------------
| kiwi 1.1.2
| Copyright (c) 2014-2019, Nucleic Development Team & H. Rutjes.
|
| Distributed under the terms of the Modified BSD License.
|
| The full license is in the file COPYING.txt, distributed with this software.
-----------------------------------------------------------------------------*/

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).kiwi={})}(this,function(m){"use strict";function l(){return new t}var t=(i.prototype.size=function(){return this.array.length},i.prototype.empty=function(){return 0===this.array.length},i.prototype.itemAt=function(t){return this.array[t]},i.prototype.contains=function(t){return void 0!==this.index[t.id()]},i.prototype.find=function(t){var e=this.index[t.id()];return void 0===e?void 0:this.array[e]},i.prototype.setDefault=function(t,e){var r=this.index[t.id()];if(void 0!==r)return this.array[r];var i=new o(t,e());return this.index[t.id()]=this.array.length,this.array.push(i),i},i.prototype.insert=function(t,e){var r=new o(t,e),i=this.index[t.id()];return void 0===i?(this.index[t.id()]=this.array.length,this.array.push(r)):this.array[i]=r,r},i.prototype.erase=function(t){var e=this.index[t.id()];if(void 0!==e){this.index[t.id()]=void 0;var r=this.array[e],i=this.array.pop();return r!==i&&(this.array[e]=i,this.index[i.first.id()]=e),r}},i.prototype.copy=function(){for(var t=new i,e=0;e<this.array.length;e++){var r=this.array[e].copy();t.array[e]=r,t.index[r.first.id()]=e}return t},i);function i(){this.index={},this.array=[]}var o=(e.prototype.copy=function(){return new e(this.first,this.second)},e);function e(t,e){this.first=t,this.second=e}var d=(r.prototype.id=function(){return this._id},r.prototype.name=function(){return this._name},r.prototype.setName=function(t){this._name=t},r.prototype.context=function(){return this._context},r.prototype.setContext=function(t){this._context=t},r.prototype.value=function(){return this._value},r.prototype.setValue=function(t){this._value=t},r.prototype.plus=function(t){return new v(this,t)},r.prototype.minus=function(t){return new v(this,"number"==typeof t?-t:[-1,t])},r.prototype.multiply=function(t){return new v([t,this])},r.prototype.divide=function(t){return new v([1/t,this])},r.prototype.toJSON=function(){return{name:this._name,value:this._value}},r.prototype.toString=function(){return this._context+"["+this._name+":"+this._value+"]"},r);function r(t){void 0===t&&(t=""),this._value=0,this._context=null,this._id=n++,this._name=t}var n=0,v=(s.prototype.terms=function(){return this._terms},s.prototype.constant=function(){return this._constant},s.prototype.value=function(){for(var t=this._constant,e=0,r=this._terms.size();e<r;e++){var i=this._terms.itemAt(e);t+=i.first.value()*i.second}return t},s.prototype.plus=function(t){return new s(this,t)},s.prototype.minus=function(t){return new s(this,"number"==typeof t?-t:[-1,t])},s.prototype.multiply=function(t){return new s([t,this])},s.prototype.divide=function(t){return new s([1/t,this])},s.prototype.isConstant=function(){return 0==this._terms.size()},s.prototype.toString=function(){var t=this._terms.array.map(function(t){return t.second+"*"+t.first.toString()}).join(" + ");return this.isConstant()||0===this._constant||(t+=" + "),t+=this._constant},s);function s(){var t=function(t){for(var e=0,r=function(){return 0},i=l(),o=0,n=t.length;o<n;++o){var s=t[o];if("number"==typeof s)e+=s;else if(s instanceof d)i.setDefault(s,r).second+=1;else if(s instanceof v){e+=s.constant();for(var a=s.terms(),c=0,p=a.size();c<p;c++){var u=a.itemAt(c);i.setDefault(u.first,r).second+=u.second}}else{if(!(s instanceof Array))throw new Error("invalid Expression argument: "+s);if(2!==s.length)throw new Error("array must have length 2");var f=s[0],h=s[1];if("number"!=typeof f)throw new Error("array item 0 must be a number");if(h instanceof d)i.setDefault(h,r).second+=f;else{if(!(h instanceof v))throw new Error("array item 1 must be a variable or expression");e+=h.constant()*f;for(a=h.terms(),c=0,p=a.size();c<p;c++){u=a.itemAt(c);i.setDefault(u.first,r).second+=u.second*f}}}}return{terms:i,constant:e}}(arguments);this._terms=t.terms,this._constant=t.constant}var a,b=(c.create=function(t,e,r,i){void 0===i&&(i=1);var o=0;return o+=1e6*Math.max(0,Math.min(1e3,t*i)),o+=1e3*Math.max(0,Math.min(1e3,e*i)),o+=Math.max(0,Math.min(1e3,r*i))},c.clip=function(t){return Math.max(0,Math.min(c.required,t))},c.required=c.create(1e3,1e3,1e3),c.strong=c.create(1,0,0),c.medium=c.create(0,1,0),c.weak=c.create(0,0,1),c);function c(){}(a=m.Operator||(m.Operator={}))[a.Le=0]="Le",a[a.Ge=1]="Ge",a[a.Eq=2]="Eq";var p=(u.prototype.id=function(){return this._id},u.prototype.expression=function(){return this._expression},u.prototype.op=function(){return this._operator},u.prototype.strength=function(){return this._strength},u.prototype.toString=function(){return this._expression.toString()+" "+["<=",">=","="][this._operator]+" 0 ("+this._strength.toString()+")"},u);function u(t,e,r,i){void 0===i&&(i=b.required),this._id=h++,this._operator=e,this._strength=b.clip(i),this._expression=void 0===r&&t instanceof v?t:t.minus(r)}var w,f,h=0,y=(_.prototype.createConstraint=function(t,e,r,i){void 0===i&&(i=b.required);var o=new p(t,e,r,i);return this.addConstraint(o),o},_.prototype.addConstraint=function(t){if(void 0!==this._cnMap.find(t))throw new Error("duplicate constraint");var e=this._createRow(t),r=e.row,i=e.tag,o=this._chooseSubject(r,i);if(o.type()===w.Invalid&&r.allDummies()){if(!M(r.constant()))throw new Error("unsatisfiable constraint");o=i.marker}if(o.type()===w.Invalid){if(!this._addWithArtificialVariable(r))throw new Error("unsatisfiable constraint")}else r.solveFor(o),this._substitute(o,r),this._rowMap.insert(o,r);this._cnMap.insert(t,i),this._optimize(this._objective)},_.prototype.removeConstraint=function(t){var e=this._cnMap.erase(t);if(void 0===e)throw new Error("unknown constraint");this._removeConstraintEffects(t,e.second);var r=e.second.marker,i=this._rowMap.erase(r);if(void 0===i){var o=this._getMarkerLeavingSymbol(r);if(o.type()===w.Invalid)throw new Error("failed to find leaving row");(i=this._rowMap.erase(o)).second.solveForEx(o,r),this._substitute(r,i.second)}this._optimize(this._objective)},_.prototype.hasConstraint=function(t){return this._cnMap.contains(t)},_.prototype.addEditVariable=function(t,e){if(void 0!==this._editMap.find(t))throw new Error("duplicate edit variable");if((e=b.clip(e))===b.required)throw new Error("bad required strength");var r=new v(t),i=new p(r,m.Operator.Eq,void 0,e);this.addConstraint(i);var o={tag:this._cnMap.find(i).second,constraint:i,constant:0};this._editMap.insert(t,o)},_.prototype.removeEditVariable=function(t){var e=this._editMap.erase(t);if(void 0===e)throw new Error("unknown edit variable");this.removeConstraint(e.second.constraint)},_.prototype.hasEditVariable=function(t){return this._editMap.contains(t)},_.prototype.suggestValue=function(t,e){var r=this._editMap.find(t);if(void 0===r)throw new Error("unknown edit variable");var i=this._rowMap,o=r.second,n=e-o.constant;o.constant=e;var s=o.tag.marker,a=i.find(s);if(void 0!==a)return a.second.add(-n)<0&&this._infeasibleRows.push(s),void this._dualOptimize();var c=o.tag.other;if(void 0!==(a=i.find(c)))return a.second.add(n)<0&&this._infeasibleRows.push(c),void this._dualOptimize();for(var p=0,u=i.size();p<u;++p){var f=i.itemAt(p),h=f.second,l=h.coefficientFor(s);0!==l&&h.add(n*l)<0&&f.first.type()!==w.External&&this._infeasibleRows.push(f.first)}this._dualOptimize()},_.prototype.updateVariables=function(){for(var t=this._varMap,e=this._rowMap,r=0,i=t.size();r<i;++r){var o=t.itemAt(r),n=e.find(o.second);void 0!==n?o.first.setValue(n.second.constant()):o.first.setValue(0)}},_.prototype._getVarSymbol=function(t){var e=this;return this._varMap.setDefault(t,function(){return e._makeSymbol(w.External)}).second},_.prototype._createRow=function(t){for(var e=t.expression(),r=new x(e.constant()),i=e.terms(),o=0,n=i.size();o<n;++o){var s=i.itemAt(o);if(!M(s.second)){var a=this._getVarSymbol(s.first),c=this._rowMap.find(a);void 0!==c?r.insertRow(c.second,s.second):r.insertSymbol(a,s.second)}}var p=this._objective,u=t.strength(),f={marker:g,other:g};switch(t.op()){case m.Operator.Le:case m.Operator.Ge:var h=t.op()===m.Operator.Le?1:-1,l=this._makeSymbol(w.Slack);if(f.marker=l,r.insertSymbol(l,h),u<b.required){var d=this._makeSymbol(w.Error);f.other=d,r.insertSymbol(d,-h),p.insertSymbol(d,u)}break;case m.Operator.Eq:if(u<b.required){var v=this._makeSymbol(w.Error),y=this._makeSymbol(w.Error);f.marker=v,f.other=y,r.insertSymbol(v,-1),r.insertSymbol(y,1),p.insertSymbol(v,u),p.insertSymbol(y,u)}else{var _=this._makeSymbol(w.Dummy);f.marker=_,r.insertSymbol(_)}}return r.constant()<0&&r.reverseSign(),{row:r,tag:f}},_.prototype._chooseSubject=function(t,e){for(var r=t.cells(),i=0,o=r.size();i<o;++i){var n=r.itemAt(i);if(n.first.type()===w.External)return n.first}var s=e.marker.type();return(s===w.Slack||s===w.Error)&&t.coefficientFor(e.marker)<0?e.marker:((s=e.other.type())===w.Slack||s===w.Error)&&t.coefficientFor(e.other)<0?e.other:g},_.prototype._addWithArtificialVariable=function(t){var e=this._makeSymbol(w.Slack);this._rowMap.insert(e,t.copy()),this._artificial=t.copy(),this._optimize(this._artificial);var r=M(this._artificial.constant());this._artificial=null;var i=this._rowMap.erase(e);if(void 0!==i){var o=i.second;if(o.isConstant())return r;var n=this._anyPivotableSymbol(o);if(n.type()===w.Invalid)return!1;o.solveForEx(e,n),this._substitute(n,o),this._rowMap.insert(n,o)}for(var s=this._rowMap,a=0,c=s.size();a<c;++a)s.itemAt(a).second.removeSymbol(e);return this._objective.removeSymbol(e),r},_.prototype._substitute=function(t,e){for(var r=this._rowMap,i=0,o=r.size();i<o;++i){var n=r.itemAt(i);n.second.substitute(t,e),n.second.constant()<0&&n.first.type()!==w.External&&this._infeasibleRows.push(n.first)}this._objective.substitute(t,e),this._artificial&&this._artificial.substitute(t,e)},_.prototype._optimize=function(t){for(;;){var e=this._getEnteringSymbol(t);if(e.type()===w.Invalid)return;var r=this._getLeavingSymbol(e);if(r.type()===w.Invalid)throw new Error("the objective is unbounded");var i=this._rowMap.erase(r).second;i.solveForEx(r,e),this._substitute(e,i),this._rowMap.insert(e,i)}},_.prototype._dualOptimize=function(){for(var t=this._rowMap,e=this._infeasibleRows;0!==e.length;){var r=e.pop(),i=t.find(r);if(void 0!==i&&i.second.constant()<0){var o=this._getDualEnteringSymbol(i.second);if(o.type()===w.Invalid)throw new Error("dual optimize failed");var n=i.second;t.erase(r),n.solveForEx(r,o),this._substitute(o,n),t.insert(o,n)}}},_.prototype._getEnteringSymbol=function(t){for(var e=t.cells(),r=0,i=e.size();r<i;++r){var o=e.itemAt(r),n=o.first;if(o.second<0&&n.type()!==w.Dummy)return n}return g},_.prototype._getDualEnteringSymbol=function(t){for(var e=Number.MAX_VALUE,r=g,i=t.cells(),o=0,n=i.size();o<n;++o){var s=i.itemAt(o),a=s.first,c=s.second;if(0<c&&a.type()!==w.Dummy){var p=this._objective.coefficientFor(a)/c;p<e&&(e=p,r=a)}}return r},_.prototype._getLeavingSymbol=function(t){for(var e=Number.MAX_VALUE,r=g,i=this._rowMap,o=0,n=i.size();o<n;++o){var s=i.itemAt(o),a=s.first;if(a.type()!==w.External){var c=s.second,p=c.coefficientFor(t);if(p<0){var u=-c.constant()/p;u<e&&(e=u,r=a)}}}return r},_.prototype._getMarkerLeavingSymbol=function(t){for(var e=Number.MAX_VALUE,r=e,i=e,o=g,n=o,s=o,a=o,c=this._rowMap,p=0,u=c.size();p<u;++p){var f=c.itemAt(p),h=f.second,l=h.coefficientFor(t);if(0!==l){var d=f.first;if(d.type()===w.External)a=d;else if(l<0)(v=-h.constant()/l)<r&&(r=v,n=d);else{var v;(v=h.constant()/l)<i&&(i=v,s=d)}}}return n!==o?n:s!==o?s:a},_.prototype._removeConstraintEffects=function(t,e){e.marker.type()===w.Error&&this._removeMarkerEffects(e.marker,t.strength()),e.other.type()===w.Error&&this._removeMarkerEffects(e.other,t.strength())},_.prototype._removeMarkerEffects=function(t,e){var r=this._rowMap.find(t);void 0!==r?this._objective.insertRow(r.second,-e):this._objective.insertSymbol(t,-e)},_.prototype._anyPivotableSymbol=function(t){for(var e=t.cells(),r=0,i=e.size();r<i;++r){var o=e.itemAt(r),n=o.first.type();if(n===w.Slack||n===w.Error)return o.first}return g},_.prototype._makeSymbol=function(t){return new E(t,this._idTick++)},_);function _(){this._cnMap=l(),this._rowMap=l(),this._varMap=l(),this._editMap=l(),this._infeasibleRows=[],this._objective=new x,this._artificial=null,this._idTick=0}function M(t){return t<0?-t<1e-8:t<1e-8}(f=w=w||{})[f.Invalid=0]="Invalid",f[f.External=1]="External",f[f.Slack=2]="Slack",f[f.Error=3]="Error",f[f.Dummy=4]="Dummy";var E=(S.prototype.id=function(){return this._id},S.prototype.type=function(){return this._type},S);function S(t,e){this._id=e,this._type=t}var g=new E(w.Invalid,-1),x=(k.prototype.cells=function(){return this._cellMap},k.prototype.constant=function(){return this._constant},k.prototype.isConstant=function(){return this._cellMap.empty()},k.prototype.allDummies=function(){for(var t=this._cellMap,e=0,r=t.size();e<r;++e)if(t.itemAt(e).first.type()!==w.Dummy)return!1;return!0},k.prototype.copy=function(){var t=new k(this._constant);return t._cellMap=this._cellMap.copy(),t},k.prototype.add=function(t){return this._constant+=t},k.prototype.insertSymbol=function(t,e){void 0===e&&(e=1),M(this._cellMap.setDefault(t,function(){return 0}).second+=e)&&this._cellMap.erase(t)},k.prototype.insertRow=function(t,e){void 0===e&&(e=1),this._constant+=t._constant*e;for(var r=t._cellMap,i=0,o=r.size();i<o;++i){var n=r.itemAt(i);this.insertSymbol(n.first,n.second*e)}},k.prototype.removeSymbol=function(t){this._cellMap.erase(t)},k.prototype.reverseSign=function(){this._constant=-this._constant;for(var t=this._cellMap,e=0,r=t.size();e<r;++e){var i=t.itemAt(e);i.second=-i.second}},k.prototype.solveFor=function(t){var e=this._cellMap,r=-1/e.erase(t).second;this._constant*=r;for(var i=0,o=e.size();i<o;++i)e.itemAt(i).second*=r},k.prototype.solveForEx=function(t,e){this.insertSymbol(t,-1),this.solveFor(e)},k.prototype.coefficientFor=function(t){var e=this._cellMap.find(t);return void 0!==e?e.second:0},k.prototype.substitute=function(t,e){var r=this._cellMap.erase(t);void 0!==r&&this.insertRow(e,r.second)},k);function k(t){void 0===t&&(t=0),this._cellMap=l(),this._constant=t}m.Constraint=p,m.Expression=v,m.Solver=y,m.Strength=b,m.Variable=d,Object.defineProperty(m,"__esModule",{value:!0})});
